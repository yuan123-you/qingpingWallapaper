{"version":3,"file":"preview.js","sources":["pages/preview/preview.vue","../../../HBuilder X/HBuilderX.4.87.2025121004/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJldmlldy9wcmV2aWV3LnZ1ZQ"],"sourcesContent":["<template>\n  <view class=\"page-bg\">\n    <view class=\"preview-mask\"></view>\n    <view class=\"preview-container\">\n      <view class=\"preview-header\">\n        <view class=\"back-btn\" @click=\"goBack\">\n          <uni-icons type=\"left\" size=\"24\" color=\"#fff\"></uni-icons>\n        </view>\n      </view>\n      \n      <swiper class=\"preview-swiper\" :current=\"currentIndex\" @change=\"handleSwiperChange\">\n        <swiper-item v-for=\"(item, index) in wallpaperList\" :key=\"index\">\n          <image \n            class=\"preview-image\" \n            :src=\"item.pic_url\" \n            mode=\"aspectFit\"\n            @longpress=\"handleLongPress(item)\"\n          ></image>\n        </swiper-item>\n      </swiper>\n\n      <view class=\"preview-info\">\n        <text class=\"preview-title\">{{ currentWallpaper.title || '壁纸' }}</text>\n        <view class=\"preview-meta\">\n          <view class=\"preview-tags\">\n            <text \n              class=\"tag-item\" \n              v-for=\"(tag, index) in currentWallpaper.tags\" \n              :key=\"index\"\n            >\n              {{ tag }}\n            </text>\n          </view>\n          <view class=\"preview-stats\">\n            <text class=\"stat-item\">下载 {{ formatNumber(currentWallpaper.download_count || 0) }}</text>\n            <text class=\"stat-item\">收藏 {{ formatNumber(currentWallpaper.favorite_count || 0) }}</text>\n          </view>\n        </view>\n      </view>\n\n      <view class=\"preview-actions\">\n        <button class=\"action-btn favorite-btn\" @click=\"handleFavorite\">\n          <text :class=\"['icon', isFavorite ? 'active' : '']\">{{ isFavorite ? '♥' : '♡' }}</text>\n          <text>收藏</text>\n        </button>\n        <button class=\"action-btn rating-btn\" @click=\"handleRating\">\n          <text class=\"icon\">★</text>\n          <text>评分</text>\n        </button>\n        <button class=\"action-btn download-btn\" @click=\"handleDownload\">\n          <text class=\"icon\">↓</text>\n          <text>下载</text>\n        </button>\n        <button class=\"action-btn share-btn\" open-type=\"share\">\n          <text class=\"icon\">↗</text>\n          <text>分享</text>\n        </button>\n      </view>\n    </view>\n  </view>\n</template>\n\n<script setup>\nimport { ref, computed, onMounted } from 'vue'\nimport { getWallpaperDetail, addUserBehavior, submitWallpaperScore } from '@/api/user/index.js'\nimport { useUserStore } from '@/stores/user'\n\nconst userStore = useUserStore()\n\nconst wallpaperId = ref('')\nconst currentIndex = ref(0)\nconst wallpaperList = ref([])\n\nconst isFavorite = computed(() => {\n  return userStore.favorites.some(item => item.id === currentWallpaper.value.id)\n})\n\nconst currentWallpaper = computed(() => {\n  return wallpaperList.value[currentIndex.value] || {}\n})\n\nonMounted(() => {\n  const pages = getCurrentPages()\n  const currentPage = pages[pages.length - 1]\n  wallpaperId.value = currentPage.options.id\n  loadWallpaper()\n})\n\nasync function loadWallpaper() {\n  try {\n    const res = await getWallpaperDetail(wallpaperId.value)\n    if (res && res.wallpaper) {\n      wallpaperList.value = [res.wallpaper]\n      \n      userStore.addHistory(res.wallpaper)\n      \n      await addUserBehavior({\n        type: 'view',\n        wall_id: wallpaperId.value,\n        openid: userStore.userInfo?.openid || ''\n      })\n    }\n  } catch (error) {\n    console.error('加载壁纸失败:', error)\n  }\n}\n\nfunction handleSwiperChange(e) {\n  currentIndex.value = e.detail.current\n}\n\nfunction goBack() {\n  uni.navigateBack()\n}\n\nfunction handleLongPress(item) {\n  uni.showActionSheet({\n    itemList: ['保存到相册', '收藏'],\n    success: (res) => {\n      if (res.tapIndex === 0) {\n        handleDownload()\n      } else if (res.tapIndex === 1) {\n        handleFavorite()\n      }\n    }\n  })\n}\n\nasync function handleFavorite() {\n  if (!userStore.userInfo) {\n    uni.showModal({\n      title: '提示',\n      content: '请先登录',\n      confirmText: '去登录',\n      success: (res) => {\n        if (res.confirm) {\n          uni.navigateTo({\n            url: '/pages/login/login'\n          })\n        }\n      }\n    })\n    return\n  }\n  \n  if (isFavorite.value) {\n    userStore.removeFavorite(currentWallpaper.value.id)\n    uni.showToast({\n      title: '已取消收藏',\n      icon: 'success'\n    })\n  } else {\n    userStore.addFavorite(currentWallpaper.value)\n    uni.showToast({\n      title: '收藏成功',\n      icon: 'success'\n    })\n    \n    await addUserBehavior({\n      type: 'favorite',\n      wall_id: currentWallpaper.value.id,\n      openid: userStore.userInfo?.openid || ''\n    })\n  }\n}\n\nasync function handleDownload() {\n  try {\n    uni.showLoading({\n      title: '下载中...'\n    })\n    \n    const downloadTask = uni.downloadFile({\n      url: currentWallpaper.value.pic_url,\n      success: (res) => {\n        if (res.statusCode === 200) {\n          uni.saveImageToPhotosAlbum({\n            filePath: res.tempFilePath,\n            success: () => {\n              uni.showToast({\n                title: '保存成功',\n                icon: 'success'\n              })\n              \n              addUserBehavior({\n                type: 'download',\n                wall_id: currentWallpaper.value.id,\n                openid: userStore.userInfo?.openid || ''\n              })\n            },\n            fail: () => {\n              uni.showToast({\n                title: '保存失败',\n                icon: 'none'\n              })\n            }\n          })\n        }\n      },\n      fail: () => {\n        uni.showToast({\n          title: '下载失败',\n          icon: 'none'\n        })\n      },\n      complete: () => {\n        uni.hideLoading()\n      }\n    })\n  } catch (error) {\n    console.error('下载失败:', error)\n    uni.hideLoading()\n  }\n}\n\nasync function handleRating() {\n  if (!userStore.userInfo) {\n    uni.showModal({\n      title: '提示',\n      content: '请先登录',\n      confirmText: '去登录',\n      success: (res) => {\n        if (res.confirm) {\n          uni.navigateTo({\n            url: '/pages/login/login'\n          })\n        }\n      }\n    })\n    return\n  }\n  \n  uni.showActionSheet({\n    itemList: ['5分 - 非常好', '4分 - 很好', '3分 - 一般', '2分 - 较差', '1分 - 很差'],\n    success: async (res) => {\n      const score = 5 - res.tapIndex\n      try {\n        await submitWallpaperScore({\n          wall_id: currentWallpaper.value.id,\n          score: score\n        })\n        uni.showToast({\n          title: '评分成功',\n          icon: 'success'\n        })\n      } catch (error) {\n        console.error('评分失败:', error)\n        uni.showToast({\n          title: '评分失败',\n          icon: 'none'\n        })\n      }\n    }\n  })\n}\n\nfunction formatNumber(num) {\n  if (num >= 10000) {\n    return (num / 10000).toFixed(1) + '万'\n  } else if (num >= 1000) {\n    return (num / 1000).toFixed(1) + 'k'\n  }\n  return num.toString()\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.preview-mask {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: rgba(0, 0, 0, 0.95);\n  z-index: 9998;\n  pointer-events: auto;\n}\n\n.page-bg {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: #000;\n  z-index: 9999;\n  pointer-events: auto;\n}\n\n.preview-container {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  z-index: 10000;\n  background: transparent;\n  overflow: hidden;\n  pointer-events: auto;\n}\n\n.preview-swiper {\n  width: 100%;\n  height: calc(100vh - 400rpx);\n  position: relative;\n  z-index: 10001;\n  pointer-events: auto;\n}\n\n.preview-header {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  z-index: 10003;\n  padding: 20rpx 30rpx;\n  padding-top: calc(20rpx + env(safe-area-inset-top));\n}\n\n.back-btn {\n  width: 70rpx;\n  height: 70rpx;\n  background: rgba(0, 0, 0, 0.5);\n  border-radius: 50%;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  backdrop-filter: blur(10rpx);\n}\n\n.preview-image {\n  width: 100%;\n  height: 100%;\n  display: block;\n  pointer-events: none;\n}\n\n.preview-info {\n  padding: 30rpx;\n  background: rgba(255, 255, 255, 0.95);\n  position: relative;\n  z-index: 10002;\n  backdrop-filter: blur(10rpx);\n}\n\n.preview-title {\n  font-size: 36rpx;\n  font-weight: 600;\n  color: #333;\n  display: block;\n  margin-bottom: 20rpx;\n}\n\n.preview-meta {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n}\n\n.preview-tags {\n  display: flex;\n  gap: 10rpx;\n  flex-wrap: wrap;\n}\n\n.tag-item {\n  font-size: 24rpx;\n  color: #28b389;\n  background: rgba(40, 179, 137, 0.1);\n  padding: 8rpx 16rpx;\n  border-radius: 4rpx;\n}\n\n.preview-stats {\n  display: flex;\n  gap: 30rpx;\n}\n\n.stat-item {\n  font-size: 24rpx;\n  color: #666;\n}\n\n.preview-actions {\n  display: flex;\n  gap: 20rpx;\n  padding: 30rpx;\n  background: rgba(255, 255, 255, 0.95);\n  margin-top: 20rpx;\n  position: relative;\n  z-index: 10003;\n  backdrop-filter: blur(10rpx);\n}\n\n.action-btn {\n  flex: 1;\n  height: 80rpx;\n  border-radius: 40rpx;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 10rpx;\n  font-size: 28rpx;\n  border: none;\n}\n\n.favorite-btn {\n  background: #FFF0F0;\n  color: #FF4757;\n}\n\n.favorite-btn .icon.active {\n  color: #FF4757;\n}\n\n.rating-btn {\n  background: #FFF8E1;\n  color: #FFB300;\n}\n\n.download-btn {\n  background: linear-gradient(135deg, #28b389, #40c79c);\n  color: #fff;\n}\n\n.share-btn {\n  background: #E8F5E9;\n  color: #28b389;\n}\n</style>\n","import MiniProgramPage from 'D:/HBuilderPrograms/qingpingWallapaper/frontend/pages/preview/preview.vue'\nwx.createPage(MiniProgramPage)"],"names":["useUserStore","ref","computed","onMounted","getWallpaperDetail","addUserBehavior","uni","submitWallpaperScore"],"mappings":"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"}
{"version":3,"file":"request.js","sources":["utils/request.js"],"sourcesContent":["import apiRouter from './api-router.js'\n\nconst BASE_URL = apiRouter.getBestEndpoint() || 'https://qingping-wallpaper-api.1628973345.workers.dev'\n\nconst CACHE_PREFIX = 'api_cache_'\nconst CACHE_DURATION = 5 * 60 * 1000\n\nfunction getCacheKey(url, method, data) {\n  return `${CACHE_PREFIX}${method}_${url}_${JSON.stringify(data)}`\n}\n\nfunction getCache(key) {\n  try {\n    const cached = uni.getStorageSync(key)\n    if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\n      return cached.data\n    }\n    return null\n  } catch (e) {\n    return null\n  }\n}\n\nfunction setCache(key, data) {\n  try {\n    uni.setStorageSync(key, {\n      data,\n      timestamp: Date.now()\n    })\n  } catch (e) {\n    console.warn('Cache set failed:', e)\n  }\n}\n\nconst request = (options) => {\n  return new Promise((resolve, reject) => {\n    const cacheKey = getCacheKey(options.url, options.method || 'GET', options.data)\n    \n    if ((options.method || 'GET') === 'GET' && !options.noCache) {\n      const cached = getCache(cacheKey)\n      if (cached) {\n        console.log('Using cached data for:', options.url)\n        resolve(cached)\n        return\n      }\n    }\n    \n    const maxRetries = 3\n    let retryCount = 0\n    let endpointIndex = 0\n    const baseTimeout = options.timeout || 15000\n    \n    const makeRequest = () => {\n      const currentEndpoint = apiRouter.API_ENDPOINTS[endpointIndex % apiRouter.API_ENDPOINTS.length]\n      const currentTimeout = baseTimeout * (retryCount + 1)\n      \n      console.log(`Requesting ${currentEndpoint}${options.url} (attempt ${retryCount + 1}/${maxRetries})`)\n      \n      uni.request({\n        url: currentEndpoint + options.url,\n        method: options.method || 'GET',\n        data: options.data || {},\n        header: {\n          'Content-Type': 'application/json',\n          'Authorization': uni.getStorageSync('token') || '',\n          ...options.header\n        },\n        timeout: currentTimeout,\n        success: (res) => {\n          if (res.statusCode === 200) {\n            if (res.data.errCode === 0) {\n              if ((options.method || 'GET') === 'GET' && !options.noCache) {\n                setCache(cacheKey, res.data)\n              }\n              resolve(res.data)\n            } else {\n              if (retryCount < maxRetries && res.data.errCode !== 401) {\n                retryCount++\n                if (res.statusCode >= 500 || res.statusCode === 0) {\n                  endpointIndex++\n                }\n                console.log(`Retry ${retryCount}/${maxRetries} for:`, options.url)\n                setTimeout(makeRequest, 1000 * retryCount)\n              } else {\n                uni.showToast({\n                  title: res.data.errMsg || '请求失败',\n                  icon: 'none',\n                  duration: 2000\n                })\n                reject(res.data)\n              }\n            }\n          } else {\n            if (retryCount < maxRetries) {\n              retryCount++\n              endpointIndex++\n              console.log(`Retry ${retryCount}/${maxRetries} for status ${res.statusCode}:`, options.url)\n              setTimeout(makeRequest, 1000 * retryCount)\n            } else {\n              uni.showToast({\n                title: '网络错误，请稍后重试',\n                icon: 'none',\n                duration: 2000\n              })\n              reject(res)\n            }\n          }\n        },\n        fail: (err) => {\n          apiRouter.markEndpointFailed(currentEndpoint)\n          \n          if (retryCount < maxRetries) {\n            retryCount++\n            endpointIndex++\n            console.log(`Retry ${retryCount}/${maxRetries} for network error:`, options.url)\n            setTimeout(makeRequest, 1000 * retryCount)\n          } else {\n            uni.showToast({\n              title: '网络连接失败，请检查网络',\n              icon: 'none',\n              duration: 2000\n            })\n            reject(err)\n          }\n        }\n      })\n    }\n    \n    makeRequest()\n  })\n}\n\nexport default {\n  get(url, data = {}) {\n    return request({\n      url,\n      method: 'GET',\n      data\n    })\n  },\n  \n  post(url, data = {}) {\n    return request({\n      url,\n      method: 'POST',\n      data\n    })\n  },\n  \n  put(url, data = {}) {\n    return request({\n      url,\n      method: 'PUT',\n      data\n    })\n  },\n  \n  delete(url, data = {}) {\n    return request({\n      url,\n      method: 'DELETE',\n      data\n    })\n  }\n}\n"],"names":["apiRouter","uni"],"mappings":"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"}
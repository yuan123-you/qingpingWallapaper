{"version":3,"file":"user.js","sources":["stores/user.js"],"sourcesContent":["import { defineStore } from 'pinia'\nimport { ref } from 'vue'\n\nexport const useUserStore = defineStore('user', () => {\n  const defaultUserInfo = {\n    nickname: '光影拾荒者',\n    avatarUrl: '/static/default_avatar.png',\n    bio: '在这个视觉至上的时代，寻找那一抹属于自己的色彩。'\n  }\n\n  const userInfo = ref(null)\n  const favorites = ref([])\n  const history = ref([])\n  const downloads = ref([])\n  const token = ref('')\n\n  function initUserInfo() {\n    // 基础持久化加载\n    const savedUserInfo = uni.getStorageSync('userInfo')\n    if (savedUserInfo) {\n      // 确保即使有缓存，如果缺失关键字段（如头像），也能用默认值补全\n      userInfo.value = {\n        ...defaultUserInfo,\n        ...savedUserInfo\n      }\n      // 核心修复：强制清洗旧数据，如果头像包含 'unsplash' 或为空，立即重置为本地默认\n      if (!userInfo.value.avatarUrl || userInfo.value.avatarUrl.includes('unsplash')) {\n        userInfo.value.avatarUrl = defaultUserInfo.avatarUrl\n      }\n      // 同步回本地存储（修复旧数据）\n      uni.setStorageSync('userInfo', userInfo.value)\n    } else {\n      // 首次进入：设置默认并保存\n      userInfo.value = { ...defaultUserInfo }\n      uni.setStorageSync('userInfo', userInfo.value)\n    }\n\n    // 加载其他数据\n    const savedFavorites = uni.getStorageSync('favorites')\n    if (savedFavorites) favorites.value = savedFavorites\n\n    const savedHistory = uni.getStorageSync('history')\n    if (savedHistory) history.value = savedHistory\n\n    const savedDownloads = uni.getStorageSync('downloads')\n    if (savedDownloads) downloads.value = savedDownloads\n\n    const savedToken = uni.getStorageSync('token')\n    if (savedToken) token.value = savedToken\n  }\n\n  function setUserInfo(data) {\n    const newData = { ...(userInfo.value || defaultUserInfo), ...data }\n    userInfo.value = newData\n    uni.setStorageSync('userInfo', newData)\n  }\n\n  function updateAvatar(avatarUrl) {\n    if (userInfo.value) {\n      userInfo.value.avatarUrl = avatarUrl\n      uni.setStorageSync('userInfo', userInfo.value)\n    }\n  }\n\n  function updateNickname(nickname) {\n    if (userInfo.value) {\n      userInfo.value.nickname = nickname\n      uni.setStorageSync('userInfo', userInfo.value)\n    }\n  }\n\n  function addFavorite(item) {\n    const exists = favorites.value.some(fav => fav.id === item.id)\n    if (!exists) {\n      favorites.value.unshift(item)\n      uni.setStorageSync('favorites', favorites.value)\n    }\n  }\n\n  function removeFavorite(id) {\n    favorites.value = favorites.value.filter(fav => fav.id !== id)\n    uni.setStorageSync('favorites', favorites.value)\n  }\n\n  function addHistory(item) {\n    const index = history.value.findIndex(h => h.id === item.id)\n    if (index !== -1) history.value.splice(index, 1)\n\n    const historyItem = { ...item, viewTime: Date.now() }\n    history.value.unshift(historyItem)\n    if (history.value.length > 50) history.value = history.value.slice(0, 50)\n    uni.setStorageSync('history', history.value)\n  }\n\n  function clearHistory() {\n    history.value = []\n    uni.setStorageSync('history', [])\n  }\n\n  function addDownload(item) {\n    const exists = downloads.value.some(d => d.id === item.id)\n    if (!exists) {\n      downloads.value.unshift(item)\n      uni.setStorageSync('downloads', downloads.value)\n    }\n  }\n\n  function setToken(data) {\n    token.value = data\n    uni.setStorageSync('token', data)\n  }\n\n  function logout() {\n    // 退出仅清除token，保留userInfo以满足“以后直接调用”的需求\n    token.value = ''\n    uni.removeStorageSync('token')\n    // 如果需要彻底登出可以重置 userInfo \n  }\n\n  return {\n    userInfo,\n    favorites,\n    history,\n    downloads,\n    token,\n    initUserInfo,\n    setUserInfo,\n    updateAvatar,\n    updateNickname,\n    addFavorite,\n    removeFavorite,\n    addHistory,\n    clearHistory,\n    addDownload,\n    setToken,\n    logout\n  }\n})\n"],"names":["defineStore","ref","uni"],"mappings":"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"}